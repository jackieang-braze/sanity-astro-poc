---
import BareLayout from '../../layouts/BareLayout.astro'
import { getPages, getPage, getModuleViaKey } from '@lib/sanity'
import type { InferGetStaticParamsType } from 'astro'
import type {
  ModuleReference,
  HeroType,
  AnnouncementBannerType,
  CourseCardSectionType,
} from '@lib/sanity'
import Text from '@components/atoms/Text.astro'
import Container from '@components/atoms/Container.astro'
import SquiggleSection from '@components/molecules/SquiggleSection.astro'
import Heading from '@components/atoms/Heading.astro'
import AnnouncementBanner from '@components/molecules/AnnouncementBanner.astro'
import Layout from '@layouts/Layout.astro'
import SanityImage from '@components/atoms/SanityImage.astro'
import Section from '@components/Section.astro'
import Link from '@components/Link.astro'
import Flex from '@components/atoms/Flex.astro'
import CourseCard from '@components/molecules/CourseCard/CourseCard.astro'
import CourseCardSection from '@components/molecules/CourseCard/CourseCardSection.astro'

export async function getStaticPaths() {
  const pages = await getPages()

  return pages.map((page) => {
    return {
      params: {
        slug: page.slug?.current || '',
      },
    }
  })
}
type Params = InferGetStaticParamsType<typeof getStaticPaths>
const { slug } = Astro.params as Params
const page = await getPage(slug)
const modules: ModuleReference[] = page.modules

---

<Layout title={slug}>
  <BareLayout>
    <SquiggleSection bgImage={page.hero.image}>
      <Flex direction="column" gap="var(--space-md)">
        <Flex direction='column' gap="1rem">
      {
        page.hero.eyebrow && <Text weight={600} size="md">{page.hero.eyebrow}</Text>
        }
      <Heading size='d2'>{page.hero.heading}</Heading>
      <Text size="lg">{page.hero.subheading}</Text>
      </Flex>
    <Flex direction='row' gap='var(--space-sm)'>{page.hero.ctas && 
        page.hero.ctas.map((cta) =>
        (
          <Link variant={cta.variant} href={cta.externalLink} icon={cta.icon} arrow={cta.showArrow}>{cta.ctaText}</Link>
        )
      )
    }</Flex>
     </Flex>
    </SquiggleSection>
      {
        modules.map((item: ModuleReference) => {
          switch (item._type) {
            case 'announcementBanner':
              const announcementBanner = item as AnnouncementBannerType
              return (
                <Section>
                <Container width={announcementBanner.width}>
                  <AnnouncementBanner
                    heading={announcementBanner.heading}
                    subheading={announcementBanner.subheading}
                    bgImage={announcementBanner.bannerImage}
                    cta={announcementBanner.cta.ctaText}
                    url={announcementBanner.cta.externalLink}
                    linkVariant={announcementBanner.cta.variant}
                    status={announcementBanner.statusFlag}
                  />
                  <SanityImage image={announcementBanner.bannerImage} />
                </Container>
                </Section>
              )
            case 'courseCardSection':
              const section = item as CourseCardSectionType
              //wrap in section
              return (
                <Section>
                  {section.content && section.content.map((grid) =>
                (
                  <CourseCardSection
                    heading={grid.gridHeading.heading}
                    subheading={grid.gridHeading.subheading}
                    headingGroupSize={grid.gridHeading.headingSize}
                    width={grid.width}
                    columnsAtFullWidth={grid.columnsAtFullWidth}
                    courseCards={grid.cardSection}
                />                 
                )
              )}
                  </Section>
              )
            default:
              throw new Error(`Unknown module type: ${item._type}`)
          }
        })
      }
  
  </BareLayout>
</Layout>
<!-- 
<CourseCardGrid>
                {grid.cardSection && grid.cardSection.map((card) => (
                  <CourseCard
                    type={card.cardType}
                    title={card.title}
                    shortDescription={card.shortDescription}
                    ctaHref={card.slug}
                    durationMinutes={card.details.examDuration}
                    level={card.details.examLevel}
                    priceUSD={card.details.examPrice}

                  />
                ))}
                {!grid.cardSection && <Heading size="h3">Add courses!</Heading>} </CourseCardGrid> -->